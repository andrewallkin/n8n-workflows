name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -t -vvv -i ~/.ssh/id_rsa -p ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no -o ServerAliveInterval=50 -o ServerAliveCountMax=10 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<EOF
          set -euxo pipefail

          # Derive repo name from owner/repo (github.repository)
          REPO_NAME="\$(basename "${GITHUB_REPOSITORY}")"

          echo "Changing directory to /srv/apps"
          cd /srv/apps || { echo "Failed to change directory to /srv/apps"; exit 1; }

          echo "Checking if project directory '/srv/apps/\${REPO_NAME}' exists..."
          if [ -d "\${REPO_NAME}" ]; then
            echo "Deleting existing project directory '/srv/apps/\${REPO_NAME}'"
            rm -rf "\${REPO_NAME}" || { echo "Failed to delete existing project directory"; exit 1; }
          fi

          echo "Creating project directory '/srv/apps/\${REPO_NAME}'"
          mkdir -p "\${REPO_NAME}" || { echo "Failed to create project directory"; exit 1; }

          echo "Changing directory to /srv/apps/\${REPO_NAME}"
          cd "\${REPO_NAME}" || { echo "Failed to change directory to project directory"; exit 1; }

          echo "Cloning the current GitHub repository into /srv/apps/\${REPO_NAME}"
          git clone https://${{ secrets.GH_USERNAME }}:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git . || { echo "Failed to clone repository"; exit 1; }

          echo "Stopping and removing existing Docker containers (if any)..."
          docker compose down || echo "Docker compose down failed or no containers to stop"

          echo "Cleaning up unused Docker resources..."
          docker image prune -a -f || echo "Docker image prune failed"
          docker builder prune -a -f || echo "Docker builder prune failed"

          echo "Building Docker containers..."
          docker compose build || { echo "Docker compose build failed"; exit 1; }

          echo "Starting Docker containers..."
          docker compose up -d || { echo "Docker compose up failed"; exit 1; }

          echo "Deployment complete."
          EOF