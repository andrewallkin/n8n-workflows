name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -t -vvv -i ~/.ssh/id_rsa -p ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no -o ServerAliveInterval=50 -o ServerAliveCountMax=10 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<EOF
          set -euxo pipefail

          # Derive repo name from owner/repo (github.repository)
          REPO_NAME="\$(basename "${GITHUB_REPOSITORY}")"

          echo "Changing directory to /srv/apps"
          cd /srv/apps || { echo "Failed to change directory to /srv/apps"; exit 1; }

          if [ ! -d "\${REPO_NAME}/.git" ]; then
            echo "Project directory '/srv/apps/\${REPO_NAME}' does not contain a git repo. Recreating and cloning..."
            rm -rf "\${REPO_NAME}" || true
            mkdir -p "\${REPO_NAME}" || { echo "Failed to create project directory"; exit 1; }
            cd "\${REPO_NAME}" || { echo "Failed to change directory to project directory"; exit 1; }

            echo "Cloning the current GitHub repository into /srv/apps/\${REPO_NAME}"
            git clone https://${{ secrets.GH_USERNAME }}:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git . || { echo "Failed to clone repository"; exit 1; }
          else
            echo "Existing git repo detected in '/srv/apps/\${REPO_NAME}'. Updating from origin..."
            cd "\${REPO_NAME}" || { echo "Failed to change directory to project directory"; exit 1; }
            git fetch origin || { echo "Failed to fetch from origin"; exit 1; }
            git reset --hard origin/main || { echo "Failed to reset to origin/main"; exit 1; }
          fi

          echo "Stopping and removing existing Docker containers (if any)..."
          # Use --remove-orphans to clean up services no longer in the compose file
          docker compose down --remove-orphans || true 

          echo "Cleaning up unused Docker resources..."
          docker image prune -a -f || true
          docker builder prune -a -f || true

          echo "Building Docker containers..."
          docker compose build || { echo "Docker compose build failed"; exit 1; }

          echo "Starting Docker containers..."
          # Force recreate ensures network changes and environment variables are picked up
          docker compose up -d --force-recreate || { echo "Docker compose up failed"; exit 1; }

          echo "Deployment complete."
          EOF